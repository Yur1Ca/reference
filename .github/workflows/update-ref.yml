name: æ¯12å°æ—¶æ›´æ–°ä¸€æ¬¡reference
on:
  schedule:
    - cron: '0 */12 * * *'
  workflow_dispatch:

env:
  TZ: Asia/Shanghai
  SERVER_IP: 42.194.225.63
  DEPLOY_PATH: /opt/1panel/www/sites/reference/index

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸšœ æ‹‰å–æœ€æ–°ä»£ç 
        uses: actions/checkout@v3
        with:
          ref: 'main'
          repository: 'jaywcjlove/reference'

      - name: â™»ï¸ ç¼–è¯‘é™æ€æ–‡ä»¶
        run: |
          echo -e 'REF_URL=https://reference.hanacloud.site\nREF_LABEL=ç½‘ç«™é¦–é¡µ' > .env
          npm install
          npm run build
          
      - name: ğŸ“Š æ£€æŸ¥æ–‡ä»¶å¤§å°
        run: du -sh dist
          
      - name: ğŸ“¦ å‹ç¼©æ„å»ºæ–‡ä»¶
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          tar -czf dist-$TIMESTAMP.tar.gz -C dist .
          echo "å‹ç¼©å®Œæˆï¼Œæ–‡ä»¶å¤§å°:"
          du -sh dist-$TIMESTAMP.tar.gz

      - name: ğŸš€ ä¸Šä¼ å‹ç¼©åŒ…åˆ°æœåŠ¡å™¨
        uses: appleboy/scp-action@master
        with:
          host: ${{ env.SERVER_IP }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          source: "dist-*.tar.gz"
          target: "/tmp/"
          rm: true

      - name: ğŸ› ï¸ æœåŠ¡å™¨ç«¯è§£å‹éƒ¨ç½²
        uses: appleboy/ssh-action@master
        with:
          host: ${{ env.SERVER_IP }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            LATEST_TAR=$(ls -t /tmp/dist-*.tar.gz | head -1)
            
            echo "å¤‡ä»½å½“å‰ç‰ˆæœ¬..."
            BACKUP_DIR="/opt/1panel/www/sites/reference/backups/$(date +%Y%m%d%H%M%S)"
            mkdir -p "$BACKUP_DIR"
            cp -r ${{ env.DEPLOY_PATH }} "$BACKUP_DIR"
            
            echo "è§£å‹æ–°ç‰ˆæœ¬: $LATEST_TAR"
            tar -xzf "$LATEST_TAR" -C ${{ env.DEPLOY_PATH }} --strip-components=0
            
            echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
            rm -f "$LATEST_TAR"
            
            chown -R www-data:www-data ${{ env.DEPLOY_PATH }}
            chmod -R 755 ${{ env.DEPLOY_PATH }}
            
            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
            echo "å¤‡ä»½ä½ç½®: $BACKUP_DIR"
